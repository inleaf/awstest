name: Build and Deploy WAR to EC2

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout source
      uses: actions/checkout@v3

    - name: ☕ Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: 🛠️ Build WAR with Maven
      run: mvn clean package -DskipTests

    - name: 📤 Copy WAR to EC2 via SCP
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_KEY }}
        source: target/*.war
        target: /home/ec2-user/app/

    - name: 🚀 Start Spring Boot WAR on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_KEY }}
        script: |
          echo "🛑 Killing old java process (if any)..."
          pkill -f 'java -jar' || true

          echo "🧹 Cleaning previous WAR files..."
          rm -f /home/ec2-user/app/*.log

          echo "🚀 Starting new WAR app in background..."
          nohup java -jar /home/ec2-user/app/*.war --server.port=8888 > /home/ec2-user/app/log.txt 2>&1 &
